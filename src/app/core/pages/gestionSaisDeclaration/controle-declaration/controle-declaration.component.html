<div class="declaration-details-container">
    <p-toast></p-toast>
    <div class="header-actions">
      <h1>Détails de la Déclaration de Biens</h1>
      <div class="action-buttons">
        <button class="btn btn-secondary" (click)="goBack()">
          <i class="pi pi-arrow-left"></i> Retour
        </button>
        <button 
        class="btn btn-primary" 
        (click)="printDeclaration()"
        icon="pi pi-print">
          <i class="pi pi-print" style="color: white;" ></i> Imprimer
        </button>
      </div>
    </div>
  
    <div class="loading-container" *ngIf="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p>Chargement des données...</p>
    </div>
  
    <div class="error-container" *ngIf="error">
      <div class="alert alert-danger">
        Une erreur est survenue lors du chargement des données de la déclaration.
        Veuillez réessayer ultérieurement.
      </div>
      <button class="btn btn-primary" (click)="loadDeclaration()">Réessayer</button>
    </div>
  
    <div class="declaration-content" *ngIf="!loading && !error && declaration">
      <!-- En-tête de la déclaration -->
      <div class="declaration-header">
        <div class="declaration-status" [ngClass]="declaration.etatDeclaration">
          {{declaration.etatDeclaration}}
        </div>
        <div class="declaration-meta">
          <div class="meta-item">
            <span class="label">N° Déclaration:</span>
            <span class="value">{{declaration.id || 'N/A'}}</span>
          </div>
          <div class="meta-item">
            <span class="label">Date de Déclaration:</span>
            <span class="value">{{formatDate(declaration.dateDeclaration)}}</span>
          </div>
          <div class="meta-item">
            <span class="label">Type de Déclaration:</span>
            <span class="value">{{declaration.typeDeclaration || 'N/A'}}</span>
          </div>
          <div class="meta-item" *ngIf="declaration.dateValidation">
            <span class="label">Date de Validation:</span>
            <span class="value">{{formatDate(declaration.dateValidation)}}</span>
          </div>
        </div>
      </div>
  
      <!-- Section 1: Informations Personnelles -->
      <div class="section-card">
    <div class="section-header" (click)="toggleSection('informations')">
      <h2><i class="pi pi-user"style="color: orange;"></i> Assujetti</h2>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="section-content" [class.expanded]="true">
          <div class="info-grid">
            <div class="info-item">
              <span class="label">Nom:</span>
              <span class="value">{{declaration.assujetti?.nom || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Prénom:</span>
              <span class="value">{{declaration.assujetti?.prenom || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Civilité:</span>
              <span class="value">{{declaration.assujetti?.civilite.intitule || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Téléphone:</span>
              <span class="value">{{declaration.assujetti?.contacttel || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Email:</span>
              <span class="value">{{declaration.assujetti?.email || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Institution:</span>
              <span class="value">{{declaration.assujetti?.institutions?.intitule || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Administration:</span>
              <span class="value">{{declaration.assujetti?.administration?.intitule || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Fonction:</span>
              <span class="value">{{declaration.assujetti?.fonction?.intitule || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Matricule:</span>
              <span class="value">{{declaration.assujetti?.matricule || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Date prise de service:</span>
              <span class="value">{{formatDate(declaration.assujetti?.datePriseDeService)}}</span>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Section 2: Véhicules -->
      <div class="section-card" *ngIf="declaration.vehicules && declaration.vehicules.length > 0">
        <div class="section-header" (click)="toggleSection('Vehicule')">
          <h2>Véhicules</h2>
          <i class="fas" [ngClass]="isSectionExpanded('Vehicule') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('Vehicule')">
          <div class="prediction-actions">
        <button class="prediction-btn" 
                (click)="generatePredictionReportVH()"
                [disabled]="isGeneratingReport">
          <i class="pi pi-chart-line"></i>
          <span>Analyse Prédictive des Véhicules</span>
          <div class="pulse-effect"></div>
        </button>
      </div>
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Marque</th>
      <th>Immatriculation</th>
      <th>Transmission</th>
      <th>Carburant</th>
      <th>Année</th>
      <th>Valeur (FCFA)</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let vehicule of declaration.vehicules">
      <td>{{vehicule.designation?.intitule || 'N/A'}}</td>
      <td>{{vehicule.marque?.intitule || 'N/A'}}</td>
      <td>{{vehicule.immatriculation || 'N/A'}}</td>
      <td>{{vehicule.transmission?.intitule || 'N/A'}}</td>
      <td>{{vehicule.carburant?.intitule || 'N/A'}}</td>
      <td>{{vehicule.anneeAcquisition || 'N/A'}}</td>
      <td>{{formatNumber(vehicule.valeurAcquisition)}}</td>
      <td>
        <!-- Bouton de téléchargement -->
        <button *ngIf="vehicule.fileName" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadVehiculeFile(vehicule)"
                title="Télécharger le document">
          <i class="pi pi-download"></i> {{vehicule.fileName}}
        </button>
        <span *ngIf="!vehicule.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>          </div>
          <br>
              <!-- Bouton pour afficher/masquer les commentaires -->
              <button class="btn btn-sm btn-outline-primary mb-2"
              *ngIf="isSectionExpanded('Vehicule')"
              (click)="showComments['Vehicule'] = !showComments['Vehicule']"><i class="pi pi-comments"style="color: orange;"></i>
              {{ showComments['Vehicule'] ? 'Masquer les observations' : 'Voir les observations' }}
              </button>

              <!-- Composant de commentaires -->
              <app-section-comments 
              *ngIf="showComments['Vehicule']"
              [declarationId]="declarationId"
              [sectionType]="'Vehicule'"
              [currentUserId]="currentUser?.id"
              (commentAdded)="onCommentAdded($event, 'Vehicule')"
              (commentDeleted)="onCommentDeleted($event, 'Vehicule')">
              </app-section-comments>
        </div>
      </div>
  
      <!-- Section 3: Revenus -->
      <div class="section-card" *ngIf="declaration.revenus && declaration.revenus.length > 0">
        <div class="section-header" (click)="toggleSection('Revenus')">
          <h2>Revenus</h2>
          <i class="fas" [ngClass]="isSectionExpanded('Revenus') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('Revenus')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Salaire Mensuel Net</th>
      <th>Autres Revenus</th>
      <th>Date</th>
      <th>Document</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let revenu of declaration.revenus">
      <td>{{formatNumber(revenu.salaireMensuelNet)}} FCFA</td>
      <td>{{revenu.autresRevenus?.intitule || 'N/A'}}</td>
      <td>{{formatDate(revenu.dateCreation)}}</td>
      <td>
        <button *ngIf="revenu.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadRevenuFile(revenu)"
                title="Télécharger {{revenu.fileName}}">
          <i class="pi pi-file-pdf"></i>  {{revenu.fileName}}
        </button>
        <span *ngIf="!revenu.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
          <br>
              <!-- Bouton pour afficher/masquer les commentaires -->
              <button class="btn btn-sm btn-outline-primary mb-2"
              *ngIf="isSectionExpanded('Revenus')"
              (click)="showComments['Revenus'] = !showComments['Revenus']"><i class="pi pi-comments"style="color: orange;"></i>
              {{ showComments['Revenus'] ? 'Masquer les observations' : 'Voir les observations' }}
              </button>

              <!-- Composant de commentaires -->
              <app-section-comments 
              *ngIf="showComments['Revenus']"
              [declarationId]="declarationId"
              [sectionType]="'Revenus'"
              [currentUserId]="currentUser?.id"
              (commentAdded)="onCommentAdded($event, 'Revenus')"
              (commentDeleted)="onCommentDeleted($event, 'Revenus')">
              </app-section-comments>
        </div>
      </div>
  
      <!-- Section 4: Biens Fonciers Bâtis -->
      <div class="section-card" *ngIf="declaration.fonciersBatis && declaration.fonciersBatis.length > 0">
        <div class="section-header" (click)="toggleSection('FoncierBati')">
          <h2>Biens Fonciers Bâtis</h2>
          <i class="fas" [ngClass]="isSectionExpanded('FoncierBati') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('FoncierBati')">
            <div class="prediction-actions">
        <button class="prediction-btn" 
                (click)="generatePredictionReportFB()"
                [disabled]="isGeneratingReport">
          <i class="pi pi-chart-line"></i>
          <span>Analyse Prédictive des Biens Bâtis</span>
          <div class="pulse-effect"></div>
        </button>
      </div>
          <div class="table-responsive">
           <table class="table table-striped">
  <thead>
    <tr>
      <th>Nature</th>
      <th>Année Construction</th>
      <th>Mode Acquisition</th>
      <th>Superficie</th>
      <th>Localisation</th>
      <th>Usage</th>
      <th>Coût (FCFA)</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let foncier of declaration.fonciersBatis">
      <td>{{foncier.nature?.intitule || 'N/A'}}</td>
      <td>{{foncier.anneeConstruction || 'N/A'}}</td>
      <td>{{foncier.modeAcquisition?.intitule || 'N/A'}}</td>
      <td>{{foncier.superficie || 'N/A'}}</td>
      <td>{{foncier.localisation?.intitule || 'N/A'}}</td> <!-- Corrigé de localis à localisation -->
      <td>{{foncier.typeUsage?.intitule || 'N/A'}}</td>
      <td>{{formatNumber(foncier.coutAcquisitionFCFA)}} FCFA</td>
      <td>
        <button *ngIf="foncier.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadFoncierBatiFile(foncier)"
                title="Télécharger {{foncier.fileName}}"><i class="pi pi-comments"style="color: orange;"></i>
          <i class="pi pi-file-pdf"></i> {{foncier.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!foncier.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
          <br>
              <!-- Bouton pour afficher/masquer les commentaires -->
              <button class="btn btn-sm btn-outline-primary mb-2"
              *ngIf="isSectionExpanded('FoncierBati')"
              (click)="showComments['FoncierBati'] = !showComments['FoncierBati']">
              {{ showComments['FoncierBati'] ? 'Masquer les observations' : 'Voir les observations' }}
              </button>

              <!-- Composant de commentaires -->
              <app-section-comments 
              *ngIf="showComments['FoncierBati']"
              [declarationId]="declarationId"
              [sectionType]="'FoncierBati'"
              [currentUserId]="currentUser?.id"
              (commentAdded)="onCommentAdded($event, 'FoncierBati')"
              (commentDeleted)="onCommentDeleted($event, 'FoncierBati')">
              </app-section-comments>
        </div>
      </div>
  
      <!-- Section 5: Biens Fonciers Non Bâtis -->
      <div class="section-card" *ngIf="declaration.fonciersNonBatis && declaration.fonciersNonBatis.length > 0">
        <div class="section-header" (click)="toggleSection('FoncierNonBati')">
          <h2>Biens Fonciers Non Bâtis</h2>
          <i class="fas" [ngClass]="isSectionExpanded('FoncierNonBati') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('FoncierNonBati')">
  <div class="prediction-actions">
        <button class="prediction-btn" 
                (click)="generatePredictionReport()"
                [disabled]="isGeneratingReport"><i class="pi pi-comments"style="color: orange;"></i>
          <i class="pi pi-chart-line"></i>
          <span>Analyse Prédictive des Terrains</span>
          <div class="pulse-effect"></div>
        </button>
      </div>
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Nature</th>
      <th>Mode Acquisition</th>
      <th>Superficie</th>
      <th>Localité</th>
      <th>Titre Propriété</th>
      <th>Année</th>
      <th>Valeur (FCFA)</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let foncier of declaration.fonciersNonBatis">
      <td>{{foncier.nature?.intitule || 'N/A'}}</td>
      <td>{{foncier.modeAcquisition?.intitule || 'N/A'}}</td>
      <td>{{foncier.superficie || 'N/A'}}</td>
      <td>{{foncier.localite || 'N/A'}}</td>
      <td>{{foncier.titrePropriete || 'N/A'}}</td>
      <td>{{foncier.dateAquis | date:'yyyy' || 'N/A'}}</td> <!-- Corrigé dateAcquis en dateAquis -->
      <td>{{formatNumber(foncier.valeurAcquisFCFA)}} FCFA</td>
      <td>
        <button *ngIf="foncier.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadFoncierNonBatiFile(foncier)"
                title="Télécharger {{foncier.fileName}}">
          <i class="pi pi-file-pdf"></i> {{foncier.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!foncier.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('FoncierNonBati')"
           (click)="showComments['FoncierNonBati'] = !showComments['FoncierNonBati']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['FoncierNonBati'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['FoncierNonBati']"
           [declarationId]="declarationId"
           [sectionType]="'FoncierNonBati'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'FoncierNonBati')"
           (commentDeleted)="onCommentDeleted($event, 'FoncierNonBati')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 6: Emprunts -->
      <div class="section-card" *ngIf="declaration.emprunts && declaration.emprunts.length > 0">
        <div class="section-header" (click)="toggleSection('Emprunts')">
          <h2>Emprunts</h2>
          <i class="fas" [ngClass]="isSectionExpanded('Emprunts') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('Emprunts')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Institution</th>
      <th>Numéro Compte</th>
      <th>Type</th>
      <th>Montant (FCFA)</th>
      <th>Montant en cours (FCFA)</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let emprunt of declaration.emprunts">
      <td>{{emprunt.institutionsFinancieres?.intitule || 'N/A'}}</td>
      <td>{{emprunt.numeroCompte || 'N/A'}}</td>
      <td>{{emprunt.typeEmprunt?.intitule || 'N/A'}}</td>
      <td>{{formatNumber(emprunt.montantEmprunt)}} FCFA</td>
      <td>{{formatNumber(emprunt.montantRestant)}} FCFA</td>
      <td>
        <button *ngIf="emprunt.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadEmpruntFile(emprunt)"
                title="Télécharger {{emprunt.fileName}}">
          <i class="pi pi-file-pdf"></i> {{emprunt.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!emprunt.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('Emprunts')"
           (click)="showComments['Emprunts'] = !showComments['Emprunts']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['Emprunts'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['Emprunts']"
           [declarationId]="declarationId"
           [sectionType]="'Emprunts'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'Emprunts')"
           (commentDeleted)="onCommentDeleted($event, 'Emprunts')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 7: Disponibilités Bancaires -->
      <div class="section-card" *ngIf="declaration.disponibilitesBanque && declaration.disponibilitesBanque.length > 0">
        <div class="section-header" (click)="toggleSection('DisponibilitesEnBanque')">
          <h2>Disponibilités Bancaires</h2>
          <i class="fas" [ngClass]="isSectionExpanded('DisponibilitesEnBanque') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('DisponibilitesEnBanque')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Banque</th>
      <th>Numéro Compte</th>
      <th>Type Compte</th>
      <th>Solde (FCFA)</th>
      <th>Date Solde</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let disponibilite of declaration.disponibilitesBanque">
      <td>{{disponibilite.banque?.intitule || 'N/A'}}</td>
      <td>{{disponibilite.numeroCompte || 'N/A'}}</td>
      <td>{{disponibilite.typeCompte?.intitule || 'N/A'}}</td>
      <td>{{formatNumber(disponibilite.soldeFCFA)}} FCFA</td>
      <td>{{formatDate(disponibilite.dateSolde)}}</td>
      <td>
        <button *ngIf="disponibilite.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadDisponibiliteFile(disponibilite)"
                title="Télécharger {{disponibilite.fileName}}">
          <i class="pi pi-file-pdf"></i> {{disponibilite.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!disponibilite.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('DisponibilitesEnBanque')"
           (click)="showComments['DisponibilitesEnBanque'] = !showComments['DisponibilitesEnBanque']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['DisponibilitesEnBanque'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['DisponibilitesEnBanque']"
           [declarationId]="declarationId"
           [sectionType]="'DisponibilitesEnBanque'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'DisponibilitesEnBanque')"
           (commentDeleted)="onCommentDeleted($event, 'DisponibilitesEnBanque')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 8: Espèces -->
      <div class="section-card" *ngIf="declaration.especes && declaration.especes.length > 0">
        <div class="section-header" (click)="toggleSection('Especes')">
          <h2>Espèces</h2>
          <i class="fas" [ngClass]="isSectionExpanded('Especes') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('Especes')">
          <div class="table-responsive">
           <table class="table table-striped">
  <thead>
    <tr>
      <th>Monnaie</th>
      <th>Devise</th>
      <th>Taux Change</th>
      <th>Montant FCFA</th>
      <th>Total FCFA</th>
      <th>Date</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let espece of declaration.especes">
      <td>{{formatNumber(espece.monnaie)}} FCFA</td>
      <td>{{espece.devise?.intitule || 'N/A'}}</td>
      <td>{{espece.tauxChange || 'N/A'}}</td>
      <td>{{formatNumber(espece.montantFCFA)}} FCFA</td>
      <td>{{formatNumber(espece.montantTotalFCFA)}} FCFA</td>
      <td>{{formatDate(espece.dateEspece)}}</td>
      <td>
        <button *ngIf="espece.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadEspeceFile(espece)"
                title="Télécharger {{espece.fileName}}">
          <i class="pi pi-file-pdf"></i> {{espece.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!espece.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('Especes')"
           (click)="showComments['Especes'] = !showComments['Especes']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['Especes'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['Especes']"
           [declarationId]="declarationId"
           [sectionType]="'Especes'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'Especes')"
           (commentDeleted)="onCommentDeleted($event, 'Especes')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 9: Animaux -->
      <div class="section-card" *ngIf="declaration.animaux && declaration.animaux.length > 0">
        <div class="section-header" (click)="toggleSection('Animaux')">
          <h2>Animaux</h2>
          <i class="fas" [ngClass]="isSectionExpanded('Animaux') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('Animaux')">
          <div class="table-responsive">
<table class="table table-striped">
  <thead>
    <tr>
      <th>Espèce</th>
      <th>Nombre Têtes</th>
      <th>Mode Acquisition</th>
      <th>Année</th>
      <th>Valeur (FCFA)</th>
      <th>Localité</th>
      <th>Document</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let animal of declaration.animaux">
      <td>{{animal.espece || 'N/A'}}</td>
      <td>{{animal.nombreTetes || 'N/A'}}</td>
      <td>{{animal.modeAcquisition?.intitule || 'N/A'}}</td>
      <td>{{animal.anneeAcquisition | date:'yyyy' || 'N/A'}}</td>
      <td>{{formatNumber(animal.valeurAcquisition)}} FCFA</td>
      <td>{{animal.localite || 'N/A'}}</td>
      <td>
        <!-- Solution simple sans truncate -->
        <button *ngIf="animal.fileName" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadAnimauxFile(animal)"
                title="Télécharger {{animal.fileName}}"><i class="pi pi-comments"style="color: orange;"></i>
          <i class="pi pi-download"></i> {{animal.fileName}}
        </button>
        <span *ngIf="!animal.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('Animaux')"
           (click)="showComments['Animaux'] = !showComments['Animaux']">
           {{ showComments['Animaux'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['Animaux']"
           [declarationId]="declarationId"
           [sectionType]="'Animaux'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'Animaux')"
           (commentDeleted)="onCommentDeleted($event, 'Animaux')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 10: Meubles Meublants -->
      <div class="section-card" *ngIf="declaration.meublesMeublants && declaration.meublesMeublants.length > 0">
        <div class="section-header" (click)="toggleSection('MeublesMeublants')">
          <h2>Meubles Meublants</h2>
          <i class="fas" [ngClass]="isSectionExpanded('MeublesMeublants') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('MeublesMeublants')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Année</th>
      <th>Valeur (FCFA)</th>
      <th>État</th>
      <th>Document</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let meuble of declaration.meublesMeublants">
      <td>{{meuble.designation?.intitule || 'N/A'}}</td>
      <td>{{meuble.anneeAcquisition || 'N/A'}}</td>
      <td>{{formatNumber(meuble.valeurAcquisition)}} FCFA</td>
      <td>{{meuble.etatGeneral?.intitule || 'N/A'}}</td>
      <td>
        <button *ngIf="meuble.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadMeubleFile(meuble)"
                title="Télécharger {{meuble.fileName}}">
          <i class="pi pi-file-pdf"></i>  {{meuble.fileName}}
        </button>
        <span *ngIf="!meuble.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('MeublesMeublants')"
           (click)="showComments['MeublesMeublants'] = !showComments['MeublesMeublants']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['MeublesMeublants'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['MeublesMeublants']"
           [declarationId]="declarationId"
           [sectionType]="'MeublesMeublants'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'MeublesMeublants')"
           (commentDeleted)="onCommentDeleted($event, 'MeublesMeublants')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 11: Titres -->
      <div class="section-card" *ngIf="declaration.titres && declaration.titres.length > 0">
        <div class="section-header" (click)="toggleSection('Titres')">
          <h2>Titres</h2>
          <i class="fas" [ngClass]="isSectionExpanded('Titres') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('Titres')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Nature/Actions</th>
      <th>Valeur (FCFA)</th>
      <th>Emplacement</th>
      <th>Précisions</th>
      <th>Document</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let titre of declaration.titres">
      <td>{{titre.designationNatureActions?.intitule || 'N/A'}}</td>
      <td>{{formatNumber(titre.valeurEmplacement)}} FCFA</td>
      <td>{{titre.emplacement?.intitule || 'N/A'}}</td>
      <td>{{titre.autrePrecisions?.intitule || 'N/A'}}</td>
      <td>
        <button *ngIf="titre.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadTitreFile(titre)"
                title="Télécharger {{titre.fileName}}">
          <i class="pi pi-file-pdf"></i> {{titre.fileName}}
        </button>
        <span *ngIf="!titre.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('Titres')"
           (click)="showComments['Titres'] = !showComments['Titres']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['Titres'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['Titres']"
           [declarationId]="declarationId"
           [sectionType]="'Titres'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'Titres')"
           (commentDeleted)="onCommentDeleted($event, 'Titres')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 12: Créances -->
      <div class="section-card" *ngIf="declaration.creances && declaration.creances.length > 0">
        <div class="section-header" (click)="toggleSection('LesCreances')">
          <h2>Créances</h2>
          <i class="fas" [ngClass]="isSectionExpanded('LesCreances') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('LesCreances')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Débiteur</th>
      <th>Montant (FCFA)</th>
      <th>Précisions</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let creance of declaration.creances">
      <td>{{creance.debiteurs?.intitule || 'N/A'}}</td>
      <td>{{formatNumber(creance.montant)}} FCFA</td>
      <td>{{creance.autresPrecisions?.intitule || 'N/A'}}</td>
      <td>
        <button *ngIf="creance.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadCreanceFile(creance)"
                title="Télécharger {{creance.fileName}}">
          <i class="pi pi-file-pdf"></i> {{creance.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!creance.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('LesCreances')"
           (click)="showComments['LesCreances'] = !showComments['LesCreances']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['LesCreances'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['LesCreances']"
           [declarationId]="declarationId"
           [sectionType]="'LesCreances'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'LesCreances')"
           (commentDeleted)="onCommentDeleted($event, 'LesCreances')">
           </app-section-comments>
        </div>
      </div>
  
      <!-- Section 13: Autres Dettes -->
      <div class="section-card" *ngIf="declaration.autresDettes && declaration.autresDettes.length > 0">
        <div class="section-header" (click)="toggleSection('AutresDettes')">
          <h2>Autres Dettes</h2>
          <i class="fas" [ngClass]="isSectionExpanded('AutresDettes') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </div>
        <div class="section-content" *ngIf="isSectionExpanded('AutresDettes')">
          <div class="table-responsive">
            <table class="table table-striped">
  <thead>
    <tr>
      <th>Créancier</th>
      <th>Montant (FCFA)</th>
      <th>Justificatifs</th>
      <th>Précisions</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let dette of declaration.autresDettes">
      <td>{{dette.creanciers?.intitule || 'N/A'}}</td>
      <td>{{formatNumber(dette.montant)}} FCFA</td>
      <td>{{dette.justificatifs?.intitule || 'N/A'}}</td>
      <td>{{dette.autresPrecisions?.intitule || 'N/A'}}</td>
      <td>
        <button *ngIf="dette.fileName && !isDownloading" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadDetteFile(dette)"
                title="Télécharger {{dette.fileName}}">
          <i class="pi pi-file-pdf"></i> {{dette.fileName}}
        </button>
        <button *ngIf="isDownloading" class="btn btn-sm btn-outline-primary" disabled>
          <i class="pi pi-spinner pi-spin"></i> Chargement...
        </button>
        <span *ngIf="!dette.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
          </div>
           <!-- Bouton pour afficher/masquer les commentaires -->
           <button class="btn btn-sm btn-outline-primary mb-2"
           *ngIf="isSectionExpanded('AutresDettes')"
           (click)="showComments['AutresDettes'] = !showComments['AutresDettes']"><i class="pi pi-comments"style="color: orange;"></i>
           {{ showComments['AutresDettes'] ? 'Masquer les observations' : 'Voir les observations' }}
           </button>

           <!-- Composant de commentaires -->
           <app-section-comments 
           *ngIf="showComments['AutresDettes']"
           [declarationId]="declarationId"
           [sectionType]="'AutresDettes'"
           [currentUserId]="currentUser?.id"
           (commentAdded)="onCommentAdded($event, 'AutresDettes')"
           (commentDeleted)="onCommentDeleted($event, 'AutresDettes')">
           </app-section-comments>
        </div>
      </div>
      <!-- Section 14: Autres Biens de Valeur -->
<div class="section-card" *ngIf="declaration.autresBiensDeValeur && declaration.autresBiensDeValeur.length > 0">
    <div class="section-header" (click)="toggleSection('AutresBiensDeValeur')">
      <h2>Autres Biens de Valeur</h2>
      <i class="fas" [ngClass]="isSectionExpanded('AutresBiensDeValeur') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
    </div>
    <div class="section-content" *ngIf="isSectionExpanded('AutresBiensDeValeur')">
      <div class="table-responsive">
<table class="table table-striped">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Localité</th>
      <th>Année</th>
      <th>Valeur (FCFA)</th>
      <th>Précisions</th>
      <th>Type</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let bien of declaration.autresBiensDeValeur">
      <td>{{bien.designation?.intitule || 'N/A'}}</td>
      <td>{{bien.localite?.intitule || 'N/A'}}</td>
      <td>{{bien.anneeAcquis || 'N/A'}}</td>
      <td>{{formatNumber(bien.valeurAcquisition)}} FCFA</td>
      <td>{{bien.autrePrecisions?.intitule || 'N/A'}}</td>
      <td>{{bien.type?.intitule || 'N/A'}}</td>
      <td>
        <button *ngIf="bien.fileName" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadAutreBienFile(bien)"
                title="Télécharger {{bien.fileName}}">
          <i class="pi pi-download"></i> {{bien.fileName}}
        </button>
        <span *ngIf="!bien.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
      </div>
       <!-- Bouton pour afficher/masquer les commentaires -->
       <button class="btn btn-sm btn-outline-primary mb-2"
       *ngIf="isSectionExpanded('AutresBiensDeValeur')"
       (click)="showComments['AutresBiensDeValeur'] = !showComments['AutresBiensDeValeur']"><i class="pi pi-comments"style="color: orange;"></i>
       {{ showComments['AutresBiensDeValeur'] ? 'Masquer les observations' : 'Voir les observations' }}
       </button>

       <!-- Composant de commentaires -->
       <app-section-comments 
       *ngIf="showComments['AutresBiensDeValeur']"
       [declarationId]="declarationId"
       [sectionType]="'AutresBiensDeValeur'"
       [currentUserId]="currentUser?.id"
       (commentAdded)="onCommentAdded($event, 'AutresBiensDeValeur')"
       (commentDeleted)="onCommentDeleted($event, 'AutresBiensDeValeur')">
       </app-section-comments>
    </div>
  </div>
  
  <!-- Section 15: Appareils Électroménagers -->
  <div class="section-card" *ngIf="declaration.appareilsElectromenagers && declaration.appareilsElectromenagers.length > 0">
    <div class="section-header" (click)="toggleSection('AppareilsElectroMenagers')">
      <h2>Appareils Électroménagers</h2>
      <i class="fas" [ngClass]="isSectionExpanded('AppareilsElectroMenagers') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
    </div>
    <div class="section-content" *ngIf="isSectionExpanded('AppareilsElectroMenagers')">
      <div class="table-responsive">
<table class="table table-striped">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Année</th>
      <th>Valeur (FCFA)</th>
      <th>État</th>
      <th>Document</th> <!-- Nouvelle colonne -->
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let appareil of declaration.appareilsElectromenagers">
      <td>{{appareil.designation?.intitule || 'N/A'}}</td>
      <td>{{appareil.anneeAcquisition || 'N/A'}}</td>
      <td>{{formatNumber(appareil.valeurAcquisition)}} FCFA</td>
      <td>{{appareil.etatGeneral?.intitule || 'N/A'}}</td>
      <td>
        <button *ngIf="appareil.fileName" 
                class="btn btn-sm btn-outline-primary"
                (click)="downloadAppareilFile(appareil)"
                title="Télécharger {{appareil.fileName}}">
          <i class="pi pi-download"></i> {{appareil.fileName}}
        </button>
        <span *ngIf="!appareil.fileName">N/A</span>
      </td>
    </tr>
  </tbody>
</table>
      </div>
       <!-- Bouton pour afficher/masquer les commentaires -->
       <button class="btn btn-sm btn-outline-primary mb-2"
       *ngIf="isSectionExpanded('AppareilsElectroMenagers')"
       (click)="showComments['AppareilsElectroMenagers'] = !showComments['AppareilsElectroMenagers']"><i class="pi pi-comments"style="color: orange;"></i>
       {{ showComments['AppareilsElectroMenagers'] ? 'Masquer les observations' : 'Voir les observations' }}
       </button>

       <!-- Composant de commentaires -->
       <app-section-comments 
       *ngIf="showComments['AppareilsElectroMenagers']"
       [declarationId]="declarationId"
       [sectionType]="'AppareilsElectroMenagers'"
       [currentUserId]="currentUser?.id"
       (commentAdded)="onCommentAdded($event, 'AppareilsElectroMenagers')"
       (commentDeleted)="onCommentDeleted($event, 'AppareilsElectroMenagers')">
       </app-section-comments>
    </div>
  </div>
  <!-- Section Réservée à l'Avocat Général -->
<!-- Section Réservée à l'Avocat Général -->
<div *ngIf="isAvocatGeneral" class="section-card avocat-general-section">
  <div class="section-header">
    <h2>Avocat Général : <span class="value">{{declaration.utilisateur?.lastname || 'N/A'}} {{declaration.utilisateur?.firstname || 'N/A'}}</span></h2>
  </div>
  
  <div class="section-content">
    <!-- Formulaire pour générer un Délibéré Officiel - Masqué s'il y a des conclusions -->
    <div class="delibere-block" *ngIf="conclusions.length === 0">
      <h4><i class="pi pi-file-edit"></i>Conclusion Officiel</h4>
      <div class="form-group mb-4">
        <div class="radio-group d-flex gap-3">
          <!-- Boutons radio -->
          <div class="radio-container">
            <label>Type de réquisitoire <span class="required">*</span></label>
            <div class="radio-options">
              <div class="radio-option" [class.selected]="requisitoireType === 'acceptation'">
                <input type="radio" id="acceptation" 
                       [(ngModel)]="requisitoireType" value="acceptation">
                <label for="acceptation">
                  <i class="pi pi-check-circle"></i>
                  <div>
                    <h5>Acceptation</h5>
                  </div>
                </label>
              </div>
              
              <div class="radio-option" [class.selected]="requisitoireType === 'refus'">
                <input type="radio" id="refus" 
                       [(ngModel)]="requisitoireType" value="refus">
                <label for="refus">
                  <i class="pi pi-times-circle"></i>
                  <div>
                    <h5>Refus</h5>
                  </div>
                </label>
              </div>
            </div>
            <small class="error" *ngIf="!requisitoireType && formSubmitted">
              Sélection obligatoire
            </small>
          </div>

          <div class="form-group mb-4">
            <label for="lettreContent" class="form-label fw-bold">Contenu de la conclusion <span class="required">*</span></label>
            <textarea id="lettreContent" class="form-control" rows="8" 
                      placeholder="Rédigez votre délibéré officiel ici..."
                      [(ngModel)]="newLettreContent"></textarea>
          </div>
          
          <div class="d-flex justify-content-end gap-2">
            <button class="btn cancel" 
                    (click)="resetForm()"
                    *ngIf="newLettreContent || requisitoireType">
              <i class="pi pi-times"></i> Annuler
            </button>
            <button class="btn btn-primary" (click)="genererLettre()"
                    [disabled]="!newLettreContent || !requisitoireType">
              <i class="pi pi-file-pdf"></i> Générer PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Liste des conclusions existantes - TOUJOURS visible -->
    <div>
      <div class="conclusions-header">
        <h4><i class="pi pi-folder-open"></i>Conclusions Existantes</h4>
        <span class="conclusions-count">{{conclusions.length}}</span>
      </div>
      
      <div class="table-responsive">
        <div class="card" style="border-top: 6px solid #F57C00; border-radius: 8px; overflow: hidden;">
          <div class="flex justify-content-between align-items-center mb-4">
            <h3 class="m-0" style="font-weight: 500; color: #333; border-left: 3px solid #F57C00; padding-left: 10px;">
              Liste des Conclusions
            </h3>
          </div>

          <div class="table-container">
            <table class="conclusions-table">
              <thead>
                <tr>
                  <th>Nom du Fichier</th>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Avocat</th>
                  <th class="actions-col">Actions</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngIf="conclusions && conclusions.length > 0; else emptyMessage">
                  <tr *ngFor="let c of conclusions; let i = index">
                    <td>
                      <div class="file-cell">
                        <i class="pi pi-file-pdf file-icon"></i>
                        {{ c.nomFichier }}
                      </div>
                    </td>
                    <td>{{ formatDate(c.dateCreation) }}</td>
                    <td>
                      <span class="type-badge" [class.acceptation]="c.estAcceptation" [class.refus]="!c.estAcceptation">
                        {{ c.estAcceptation ? 'Acceptation' : 'Refus' }}
                      </span>
                    </td>
                    <td>{{ c.utilisateur?.firstname }}</td>
                    <td class="actions-cell">
                      <div class="flex gap-2">
                        <!-- Bouton télécharger -->
                        <button 
                          pButton 
                          (click)="downloadConclusion(c.id, c.nomFichier)"
                          icon="pi pi-download" 
                          class="p-button-rounded p-button-secondary p-button-text"
                          style="width: 2.25rem; height: 2.25rem;"
                          pTooltip="Télécharger PDF"
                          tooltipPosition="top">
                        </button>
                        
                        <!-- Bouton supprimer -->
                        <button 
                          *ngIf="currentUser.id === c.utilisateur?.id"
                          pButton 
                          type="button" 
                          icon="pi pi-trash" 
                          class="p-button-rounded p-button-danger p-button-text"
                          style="width: 2.25rem; height: 2.25rem;"
                          pTooltip="Supprimer"
                          tooltipPosition="top"
                          (click)="deleteConclusion(c.id, i)">
                        </button>
                      </div>
                    </td>
                  </tr>
                </ng-container>
                
                <ng-template #emptyMessage>
                  <tr>
                    <td colspan="5">
                      <div class="flex flex-column align-items-center empty-message">
                        <i class="pi pi-file-pdf mb-3"></i>
                        <span>Aucune conclusion disponible.</span>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Bouton Envoyer - Visible seulement avec des conclusions -->
    <div *ngIf="conclusions.length > 0" class="conclusion-actions">
      <button pButton 
              label="Envoyer" 
              icon="pi pi-send" 
              class="orange-button"
              (click)="envoyerDeclaration()"
              [disabled]="!conclusions.length"
              pTooltip="Transférer au procureur General"
              style="padding: 0.75rem 1.5rem; font-size: 1rem;">
      </button>
    </div>

    <!-- Message vide seulement quand aucune conclusion -->
    <div *ngIf="conclusions.length === 0" class="empty-state">
      <i class="pi pi-folder"></i>
      <p>Aucune conclusion n'a été enregistrée</p>
    </div>
  </div>
</div>